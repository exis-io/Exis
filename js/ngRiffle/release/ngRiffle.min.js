if("undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports){var jsriffle=require("jsRiffle");module.exports="ngRiffle"}!function(){"use strict";function a(){var a=void 0,b=["Application","Domain","modelObject","want"];for(var c in jsRiffle)-1===b.indexOf(c)&&(this[c]=jsRiffle[c]);this.setDomain=function(b){a=b};var d=this.interceptors=[];return this.$get=["$rootScope","$q","$log","$injector",function(b,c,e,f){function g(a){return function(){var c=a.apply(this,arguments);return b.$apply(),c}}function h(a){this.conn=a,this.conn.onJoin=n,this.conn.onLeave=o}function i(a,b){h.call(this,b),this.storage=a.subdomain("Auth")}var j=[];angular.forEach(d,function(a){j.unshift(angular.isString(a)?f.get(a):f.invoke(a))});var k,l=c.defer(),m=l.promise,n=g(function(){e.debug("Connection Opened: "),b.$broadcast("$riffle.open"),k.connected=!0,l.resolve()}),o=g(function(a,d){e.debug("Connection Closed: ",a,d),k.connected=!1,l=c.defer(),m=l.promise,b.$broadcast("$riffle.leave",{reason:a,details:d})});k=new h(jsRiffle.Domain(a)),k.want=jsRiffle.want,k.modelObject=jsRiffle.modelObject,k.connected=!1;var p=function(a,b,d){var e=function(c){return{result:c,type:a,args:b}},f=function(d){return c.reject({error:d,type:a,args:b})},g=m.then(function(){return d()}),h=[e,f];for(angular.forEach(j,function(b){(b[a+"Response"]||b[a+"ResponseError"])&&h.push(b[a+"Response"],b[a+"ResponseError"])}),h.push(function(a){return a.result},function(a){return c.reject(a.error)});h.length;){var i=h.shift(),k=h.shift();g=g.then(i,k)}return g};return h.prototype.join=function(){return this.conn.join()},h.prototype.leave=function(){return this.conn.leave()},h.prototype.subscribeOnScope=function(a,b,c){var d=this;return this.subscribe(b,c).then(function(){a.$on("$destroy",function(){return d.unsubscribe(b)})})},h.prototype.setToken=function(a){this.conn.setToken(a)},h.prototype.getToken=function(){return this.conn.getToken()},h.prototype.unsubscribe=function(a){var b=this;return p("unsubscribe",arguments,function(){return b.conn.unsubscribe(a)})},h.prototype.publish=function(){var a=arguments,b=this;return p("publish",arguments,function(){return b.conn.publish.apply(b.conn,a)})},h.prototype.register=function(a,b){"function"==typeof b?b=g(b):b.fp=g(b.fp);var c=this;return p("register",arguments,function(){return c.conn.register(a,b)})},h.prototype.subscribe=function(a,b){"function"==typeof b?b=g(b):b.fp=g(b.fp);var c=this;return p("subscribe",arguments,function(){return c.conn.subscribe(a,b)})},h.prototype.unregister=function(a){var b=this;return p("unregister",arguments,function(){return b.conn.unregister(a)})},h.prototype.call=function(){function a(){return p("want",d,function(){return f.want.apply({},g)})}function b(){return g=arguments,h.promise.then(a)}var d=arguments,e=this,f=void 0,g=void 0,h=c.defer(),i=p("call",arguments,function(){return f=e.conn.call.apply(e.conn,d),h.resolve(),f});return i.want=b,i},h.prototype.subdomain=function(a){return new h(this.conn.subdomain(a))},h.prototype.linkDomain=function(a){return new h(this.conn.linkDomain(a))},h.prototype.login=function(a){function b(){g.resolve(k.user)}function d(){k.user.load().then(g.resolve,g.reject)}function e(a){j?(k.user=new h(a),k.user.join(),m.then(b)):(k.user=new i(f,a),k.user.join(),m.then(d))}a=a||{};var f=this,g=c.defer(),j=!1;return a.password||(j=!0),this.conn.login(a).then(e,g.reject),g.promise},h.prototype.registerAccount=function(a){return this.conn.registerAccount(a)},i.prototype=Object.create(h.prototype),i.prototype.constructor=i,i.prototype.email="",i.prototype.name="",i.prototype.privateStorage={},i.prototype.publicStorage={},i.prototype.save=function(){return this.storage.call("save_user_data",this.publicStorage,this.privateStorage)},i.prototype.load=function(){function a(a){d.name=a.name,d.email=a.email,d.gravatar=a.gravatar,d.privateStorage=a["private"]||{},d.publicStorage=a["public"]||{},e.resolve(d)}function b(a){e.reject(a)}var d=this,e=c.defer();return this.storage.call("get_user_data").then(a,b),e.promise},i.prototype.getPublicData=function(a){return this.storage.call("get_public_data",a)},k}],this}angular.module("ngRiffle",[]).provider("$riffle",a)}();